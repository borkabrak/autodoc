#!/usr/bin/env ruby
#
#   Modify the JSON specfile, adding an array of objects describing each piece
#   of JSDoc commentary in the given source code file.

require 'json'
require_relative 'jsdoc'

specfile = "bin/analysis.json"

if (ARGV.length < 1) then
    puts "Usage: $0 <sourcefile>"
    exit
end

puts "Reading JSDoc.."

spec = JSON.parse(File.read(specfile))
spec[:jsdoc] = [];

sourcefile = ARGV[0]
(sourcecode = File.read(sourcefile)) or (abort("Can't open #{sourcefile}"))

# Iterate relevant blocks of code (a jsdoc comment block and the following
# function signature), collecting the pieces in the spec.
sourcecode.scan(%r{(/\*\*.*?\*/.*?function.*?\n)}m).flatten.each{ |code|

    spec[:jsdoc].push({ 
        :signature => function_signature(code),
        :name => name(function_signature(code)),
        :args => args(function_signature(code)),
        :tags => tags(comment_block(code))
    })

}

File.write(specfile, "#{JSON.pretty_generate(spec)}\n")
puts "Spec written to #{specfile}."
